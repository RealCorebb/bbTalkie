<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrueType Font to Variable Width 1-Bit Converter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
        }
        
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            margin-right: 10px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .preview {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fafafa;
        }
        
        canvas {
            border: 1px solid #ccc;
            background: white;
            margin: 10px 0;
        }
        
        .output {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .file-input {
            border: 2px dashed #ddd;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            cursor: pointer;
        }
        
        .file-input:hover {
            border-color: #007bff;
        }
        
        .font-metrics {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Variable Width Font Converter</h1>
        
        <div class="controls">
            <div class="control-group">
                <label>Upload TrueType Font (.ttf/.otf):</label>
                <div class="file-input" onclick="document.getElementById('fontFile').click()">
                    <input type="file" id="fontFile" accept=".ttf,.otf" style="display: none;">
                    <span id="fileName">Click to select font file...</span>
                </div>
            </div>
            
            <div class="control-group">
                <label for="fontSize">Font Height (pixels):</label>
                <input type="number" id="fontSize" value="16" min="8" max="32">
            </div>
            
            <div class="control-group">
                <label for="testText">Preview Text:</label>
                <input type="text" id="testText" value="Hello World 123! iIlL" placeholder="Enter text to preview">
            </div>
            
            <button onclick="generateFont()">Generate Font</button>
            <button onclick="copyCode()">Copy C Code</button>
        </div>
        
        <div class="preview">
            <h3>Preview:</h3>
            <canvas id="previewCanvas" width="700" height="120"></canvas>
            <div id="fontInfo"></div>
            <div id="fontMetrics" class="font-metrics"></div>
        </div>
        
        <div>
            <h3>Generated C Code:</h3>
            <div class="output" id="output">Upload a font and click Generate to see C code...</div>
        </div>
    </div>

    <script>
        let fontBuffer = null;
        let fontFace = null;
        
        document.getElementById('fontFile').addEventListener('change', handleFontUpload);
        
        async function handleFontUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            document.getElementById('fileName').textContent = file.name;
            
            fontBuffer = await file.arrayBuffer();
            
            // Create FontFace and load it
            try {
                fontFace = new FontFace('CustomFont', fontBuffer);
                await fontFace.load();
                document.fonts.add(fontFace);
                
                // Auto-generate preview
                setTimeout(generateFont, 100);
            } catch (error) {
                alert('Error loading font: ' + error.message);
            }
        }
        
        function generateFont() {
            if (!fontFace) {
                alert('Please upload a font file first');
                return;
            }
            
            const fontSize = parseInt(document.getElementById('fontSize').value);
            const testText = document.getElementById('testText').value;
            
            // Generate font data for ASCII 32-126
            const fontData = {};
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Set larger canvas for accurate measurement
            canvas.width = fontSize * 4;
            canvas.height = fontSize * 2;
            
            ctx.font = `${fontSize}px CustomFont`;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            
            let totalBytes = 0;
            let minWidth = fontSize;
            let maxWidth = 0;
            
            // Generate data for printable ASCII characters
            for (let i = 32; i <= 126; i++) {
                const char = String.fromCharCode(i);
                
                // Measure character width using Canvas API
                const metrics = ctx.measureText(char);
                let charWidth = Math.ceil(metrics.width);
                
                // Ensure minimum width of 1 pixel
                if (charWidth < 1) charWidth = 1;
                
                // Clear canvas
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw character
                ctx.fillStyle = 'black';
                ctx.fillText(char, 1, 1);
                
                // Get image data and convert to 1-bit
                const imageData = ctx.getImageData(0, 0, charWidth + 2, fontSize);
                const pixels = [];
                
                // Convert to 1-bit bitmap data
                for (let y = 0; y < fontSize; y++) {
                    const bytesPerRow = Math.ceil(charWidth / 8);
                    const rowBytes = [];
                    
                    for (let byteIdx = 0; byteIdx < bytesPerRow; byteIdx++) {
                        let byte = 0;
                        for (let bit = 0; bit < 8; bit++) {
                            const x = byteIdx * 8 + bit;
                            if (x < charWidth) {
                                const pixelIdx = (y * (charWidth + 2) + x + 1) * 4;
                                const brightness = (imageData.data[pixelIdx] + 
                                                 imageData.data[pixelIdx + 1] + 
                                                 imageData.data[pixelIdx + 2]) / 3;
                                if (brightness < 128) {
                                    byte |= (1 << (7 - bit));
                                }
                            }
                        }
                        rowBytes.push(byte);
                    }
                    pixels.push(...rowBytes);
                }
                
                fontData[char] = {
                    width: charWidth,
                    data: pixels,
                    bytesPerRow: Math.ceil(charWidth / 8)
                };
                
                totalBytes += pixels.length;
                minWidth = Math.min(minWidth, charWidth);
                maxWidth = Math.max(maxWidth, charWidth);
            }
            
            // Generate preview
            generatePreview(testText, fontData, fontSize);
            
            // Update font metrics
            document.getElementById('fontMetrics').innerHTML = `
Character Width Range: ${minWidth} - ${maxWidth} pixels
Total Memory Usage: ${totalBytes} bytes
Average Width: ${(totalBytes / (95 * fontSize)).toFixed(1)} bytes per char
            `;
            
            // Generate C code
            generateCCode(fontData, fontSize, totalBytes);
        }
        
        function generatePreview(text, fontData, fontSize) {
            const canvas = document.getElementById('previewCanvas');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid
            ctx.strokeStyle = '#f0f0f0';
            ctx.lineWidth = 1;
            for (let i = 0; i < canvas.width; i += 10) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, canvas.height);
                ctx.stroke();
            }
            
            // Draw preview text
            let x = 10;
            const y = 20;
            const pixelSize = 2;
            
            for (let char of text) {
                if (fontData[char]) {
                    const charData = fontData[char];
                    const charWidth = charData.width;
                    const bytesPerRow = charData.bytesPerRow;
                    
                    // Draw character pixel by pixel
                    for (let row = 0; row < fontSize; row++) {
                        for (let byteIdx = 0; byteIdx < bytesPerRow; byteIdx++) {
                            const byte = charData.data[row * bytesPerRow + byteIdx];
                            for (let bit = 0; bit < 8; bit++) {
                                const pixelX = byteIdx * 8 + bit;
                                if (pixelX < charWidth && (byte & (1 << (7 - bit)))) {
                                    ctx.fillStyle = 'black';
                                    ctx.fillRect(x + pixelX * pixelSize, y + row * pixelSize, pixelSize, pixelSize);
                                }
                            }
                        }
                    }
                    
                    // Draw character boundary
                    ctx.strokeStyle = '#007bff';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(x, y, charWidth * pixelSize, fontSize * pixelSize);
                    
                    // Add character label
                    ctx.fillStyle = '#666';
                    ctx.font = '10px Arial';
                    ctx.fillText(`${char}(${charWidth})`, x, y + fontSize * pixelSize + 12);
                    
                    x += charWidth * pixelSize + 4;
                }
            }
            
            // Update font info
            const avgWidth = Object.values(fontData).reduce((sum, char) => sum + char.width, 0) / 95;
            document.getElementById('fontInfo').innerHTML = `
                Font Height: ${fontSize} pixels<br>
                Variable Width: Yes (avg: ${avgWidth.toFixed(1)} pixels)<br>
                Characters: 95 (ASCII 32-126)
            `;
        }
        
        function generateCCode(fontData, fontSize, totalBytes) {
            let code = `// Generated variable-width 1-bit font data\n`;
            code += `// Font height: ${fontSize} pixels, variable width\n`;
            code += `// ASCII characters 32-126\n`;
            code += `// Total size: ${totalBytes} bytes\n\n`;
            
            // Generate width table
            code += `// Character width table\n`;
            code += `const uint8_t font_${fontSize}_widths[95] = {\n`;
            for (let i = 32; i <= 126; i++) {
                const char = String.fromCharCode(i);
                const width = fontData[char].width;
                code += `    ${width}`;
                if (i < 126) code += ',';
                code += ` // '${char}' (${i})\n`;
            }
            code += `};\n\n`;
            
            // Generate character data offsets
            code += `// Character data offsets\n`;
            code += `const uint16_t font_${fontSize}_offsets[95] = {\n`;
            let offset = 0;
            for (let i = 32; i <= 126; i++) {
                const char = String.fromCharCode(i);
                code += `    ${offset}`;
                if (i < 126) code += ',';
                code += ` // '${char}' (${i})\n`;
                offset += fontData[char].data.length;
            }
            code += `};\n\n`;
            
            // Generate bitmap data
            code += `// Bitmap data\n`;
            code += `const uint8_t font_${fontSize}_data[${totalBytes}] = {\n`;
            
            let dataIndex = 0;
            for (let i = 32; i <= 126; i++) {
                const char = String.fromCharCode(i);
                const charData = fontData[char];
                
                code += `    // '${char}' (${char.charCodeAt(0)}) - ${charData.width}x${fontSize} pixels\n`;
                
                for (let j = 0; j < charData.data.length; j++) {
                    if (j % 8 === 0) code += `    `;
                    code += `0x${charData.data[j].toString(16).padStart(2, '0').toUpperCase()}`;
                    if (dataIndex < totalBytes - 1) code += ',';
                    if (j % 8 === 7 || j === charData.data.length - 1) code += `\n`;
                    dataIndex++;
                }
            }
            code += `};\n\n`;
            
            // Generate font structure
            code += `// Font structure\n`;
            code += `typedef struct {\n`;
            code += `    uint8_t height;\n`;
            code += `    const uint8_t *widths;\n`;
            code += `    const uint16_t *offsets;\n`;
            code += `    const uint8_t *data;\n`;
            code += `} variable_font_t;\n\n`;
            
            code += `const variable_font_t font_${fontSize} = {\n`;
            code += `    .height = ${fontSize},\n`;
            code += `    .widths = font_${fontSize}_widths,\n`;
            code += `    .offsets = font_${fontSize}_offsets,\n`;
            code += `    .data = font_${fontSize}_data\n`;
            code += `};\n\n`;
        
            
            document.getElementById('output').textContent = code;
        }
        
        function copyCode() {
            const output = document.getElementById('output');
            const text = output.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                alert('C code copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('C code copied to clipboard!');
            });
        }
    </script>
</body>
</html>